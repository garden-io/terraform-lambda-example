kind: Deploy
name: hello-tf
type: terraform
include: [./terraform/main.tf, ./terraform/modules/hello]
spec:
  autoApply: true
  root: ./terraform
  variables:
    name: "it's a me, Mario!"

---
kind: Run
name: hello
type: exec
dependencies:
  - deploy.hello-tf
spec:
  command:
    ["echo", "Terraform output is: ${actions.deploy.hello-tf.outputs.message}"]

---
kind: Build
name: zip-lambda
type: exec
spec:
  # FIXME: This does not work (and is not cross platform)
  command:
    - "/bin/sh"
    - "-c"
    - "rm -f ./terraform/modules/lambda-hello/function.zip && \
      cd ./lambda-hello && \
      zip function.zip index.js && \
      mv function.zip ../terraform/modules/lambda-hello/ && \
      cd .."

---
kind: Deploy
name: lambda-hello
type: terraform
include: [./terraform/main.tf, ./terraform/modules/lambda-hello]
dependencies:
  - build.zip-lambda
spec:
  autoApply: true
  root: ./terraform
  variables:
    function-name: "lambda-hello"
